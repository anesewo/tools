<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>高速大容量グラフ</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .controls { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #graph { width: 100%; height: 75vh; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        .status-container { margin-top: 10px; font-size: 0.9em; }
        #status { color: #007bff; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <h2>大容量データ・インタラクティブグラフ</h2>
    
    <div class="controls">
        <p>テキストファイル（1行1数値）を選択して実行してください。</p>
        <input type="file" id="fileInput" accept=".txt,.csv">
        <button onclick="processFile()">グラフを描画</button>
        <div class="status-container">
            <span id="status">処理中... しばらくお待ちください...</span>
        </div>
    </div>

    <div id="graph"></div>

    <script>
        async function processFile() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            
            if (fileInput.files.length === 0) {
                alert("ファイルを選択してください。");
                return;
            }

            status.style.display = "inline";
            const file = fileInput.files[0];

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                // 高速なパース処理
                const lines = text.split(/[\r\n,]+/).filter(line => line.trim() !== "");
                const dataValues = new Float64Array(lines.length);
                for (let i = 0; i < lines.length; i++) {
                    dataValues[i] = Number(lines[i]);
                }

                if (dataValues.length === 0) {
                    alert("データが見つかりませんでした。");
                    status.style.display = "none";
                    return;
                }

                drawGraph(dataValues);
                status.style.display = "none";
            };

            reader.readAsText(file);
        }

        function drawGraph(yData) {
            const xData = new Float64Array(yData.length);
            for (let i = 0; i < yData.length; i++) xData[i] = i;

            const trace = {
                x: xData,
                y: yData,
                type: 'scattergl',
                mode: 'lines',
                line: { color: '#17a2b8', width: 1 }
            };

            const layout = {
                title: `データ点数: ${yData.length.toLocaleString()} 点`,
                hovermode: 'closest',
                dragmode: 'pan', 
                xaxis: { title: 'Index', autorange: true },
                yaxis: { title: 'Value', autorange: true },
                margin: { t: 50, b: 50, l: 60, r: 30 }
            };

            const config = {
                scrollZoom: true,
                responsive: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('graph', [trace], layout, config);
        }
    </script>
</body>

</html>
