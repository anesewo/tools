<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Video to Audio Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f8f9fa; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #2c3e50; }
        
        /* 設定エリア */
        .settings { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; padding: 15px; background: #f0f2f5; border-radius: 8px; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }

        .upload-area { border: 3px dashed #dee2e6; padding: 40px; text-align: center; margin-bottom: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; background: #fff; }
        .upload-area:hover { border-color: #007bff; background: #f0f7ff; }
        
        .controls { display: none; gap: 10px; margin-bottom: 20px; justify-content: center; background: #e9ecef; padding: 15px; border-radius: 8px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 4px; }
        
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-single { background: #6c757d; color: white; }
        .btn-all { background: #17a2b8; color: white; }
        .btn-zip { background: #28a745; color: white; }
        button:hover { opacity: 0.8; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #status { text-align: center; margin: 10px 0; font-weight: bold; color: #007bff; }
        .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 10px; margin-bottom: 20px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: #007bff; border-radius: 10px; transition: width 0.1s; }
    </style>
</head>
<body>

<div class="container">
    <h2>オーディオ抽出・変換ツール</h2>

    <div class="settings">
        <label><strong>出力形式:</strong></label>
        <select id="formatSelect">
            <option value="wav">WAV (高音質・無圧縮)</option>
            <option value="mp3">MP3 (軽量・192kbps)</option>
        </select>
    </div>
    
    <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
        動画または音声ファイルをドロップ<br>（MP4, MOV, MP3, WAVなど）
        <input type="file" id="fileInput" multiple accept="video/*,audio/*" style="display:none">
    </div>

    <div id="status"></div>
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="controls" id="bulkControls">
        <button class="btn-all" onclick="downloadAllIndividually()">全ファイルを個別にDL</button>
        <button class="btn-zip" onclick="downloadAsZip()">ZIPで一括DL</button>
    </div>

    <div id="fileList"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const fileList = document.getElementById('fileList');
    const bulkControls = document.getElementById('bulkControls');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const formatSelect = document.getElementById('formatSelect');

    let processedFiles = [];

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#007bff'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#dee2e6'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        handleFiles(e.dataTransfer.files);
    });

    async function handleFiles(files) {
        if (files.length === 0) return;

        processedFiles = [];
        fileList.innerHTML = '';
        bulkControls.style.display = 'none';
        progressContainer.style.display = 'block';
        const targetFormat = formatSelect.value;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            status.innerText = `変換中 (${i + 1}/${files.length}): ${file.name}`;
            updateProgress(((i) / files.length) * 100);

            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                let blob;
                let newName = `${file.name.split('.')[0]}.${targetFormat}`;

                if (targetFormat === 'mp3') {
                    blob = await encodeMp3(audioBuffer);
                } else {
                    blob = audioBufferToWav(audioBuffer);
                }
                
                processedFiles.push({ name: newName, blob: blob });
                addToFileList(newName, blob);

            } catch (err) {
                console.error(err);
                status.innerText = `エラー: ${file.name} の処理に失敗しました。`;
            }
        }

        updateProgress(100);
        status.innerText = "すべての変換が完了しました！";
        bulkControls.style.display = 'flex';
    }

    function updateProgress(percent) {
        progressBar.style.width = percent + '%';
    }

    function addToFileList(name, blob) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span>${name}</span>`;
        const btn = document.createElement('button');
        btn.className = 'btn-single';
        btn.innerText = '保存';
        btn.onclick = () => download(blob, name);
        div.appendChild(btn);
        fileList.appendChild(div);
    }

    function download(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
    }

    function downloadAllIndividually() {
        processedFiles.forEach((f, i) => {
            setTimeout(() => download(f.blob, f.name), i * 400);
        });
    }

    async function downloadAsZip() {
        status.innerText = "ZIP作成中...";
        const zip = new JSZip();
        processedFiles.forEach(f => zip.file(f.name, f.blob));
        const content = await zip.generateAsync({ type: 'blob' });
        download(content, "converted_audio.zip");
        status.innerText = "ZIPダウンロード完了";
    }

    // --- MP3 エンコードロジック ---
    async function encodeMp3(audioBuffer) {
        const channels = audioBuffer.numberOfChannels;
        const sampleRate = audioBuffer.sampleRate;
        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 192); // 192kbps
        const mp3Data = [];

        const samplesL = floatTo16Bit(audioBuffer.getChannelData(0));
        const samplesR = channels > 1 ? floatTo16Bit(audioBuffer.getChannelData(1)) : samplesL;

        let remaining = samplesL.length;
        const maxSamples = 1152;
        for (let i = 0; remaining >= maxSamples; i += maxSamples) {
            const leftChunk = samplesL.subarray(i, i + maxSamples);
            const rightChunk = samplesR.subarray(i, i + maxSamples);
            const mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
            if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
            remaining -= maxSamples;
        }
        const finish = mp3encoder.flush();
        if (finish.length > 0) mp3Data.push(new Int8Array(finish));

        return new Blob(mp3Data, { type: 'audio/mp3' });
    }

    function floatTo16Bit(input) {
        const output = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
            let s = Math.max(-1, Math.min(1, input[i]));
            output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return output;
    }

    // --- WAV エンコードロジック ---
    function audioBufferToWav(buffer) {
        const nCh = buffer.numberOfChannels, sRate = buffer.sampleRate;
        const len = buffer.length * nCh * 2 + 44;
        const ab = new ArrayBuffer(len), v = new DataView(ab);
        let p = 0;
        const writeString = s => { for (let i = 0; i < s.length; i++) v.setUint8(p + i, s.charCodeAt(i)); p += s.length; };
        const writeU32 = d => { v.setUint32(p, d, true); p += 4; };
        const writeU16 = d => { v.setUint16(p, d, true); p += 2; };

        writeString('RIFF'); writeU32(len - 8); writeString('WAVE');
        writeString('fmt '); writeU32(16); writeU16(1); writeU16(nCh);
        writeU32(sRate); writeU32(sRate * nCh * 2); writeU16(nCh * 2); writeU16(16);
        writeString('data'); writeU32(buffer.length * nCh * 2);

        for (let i = 0; i < buffer.length; i++) {
            for (let ch = 0; ch < nCh; ch++) {
                let s = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
                v.setInt16(p, s < 0 ? s * 0x8000 : s * 0x7FFF, true); p += 2;
            }
        }
        return new Blob([ab], { type: 'audio/wav' });
    }
</script>
</body>

</html>
